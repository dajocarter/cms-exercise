<!DOCTYPE html>
<html>

<head>
  <link href="css/main.css" rel="stylesheet" />
</head>

<body>
  <div id="app">
    <header>
      <div id="logo">
        <img id="logo__image" src="img/giphy_logo_with_text.png" />
      </div>
      <form id="searchform">
        <label for="query" class="screen-reader-text">Search GIFs via GIPHY</label>
        <input id="searchform__input" type="text" name="query" placeholder="Search GIFs via GIPHY" />
        <input id="searchform__submit" type="submit" value="" />
      </form>
    </header>
    <div id="container">
      <ul id="gifs"></ul>
    </div>
  </div>

  <script src="js/giphy-search.js"></script>
  <script type="text/javascript">
    // Show trending GIfs on load
    GiphySearch.search("trending");

    // Get params from plugin init
    const args = top.tinymce.activeEditor.windowManager.getParams();
    // Get editor so we can close it after selecting a GIF
    const { editor } = args;

    // Event Listeners
    const container = document.getElementById('container');
    container.addEventListener('scroll', evt => {
      const hitBottom = evt.target.scrollHeight - evt.target.scrollTop === evt.target.offsetHeight;
      if (hitBottom) GiphySearch.search();
    });

    const form = document.getElementById("searchform");
    form.addEventListener('submit', evt => {
      evt.preventDefault();

      const query = document.getElementById('searchform__input').value;
      query ? GiphySearch.search('search', query) : GiphySearch.search('trending');
    });

    const gifsList = document.getElementById("gifs");
    gifsList.addEventListener('click', evt => {
      if (evt.target) {
        // Ignore clicks on the UL or else it will embed the first gif in the list
        if (evt.target.nodeName === "UL") return;
        const gif = evt.target.nodeName === "IMG" ? evt.target : evt.target.querySelector("img");
        const gif_id = gif.dataset.gifId;
        // Inject iframe into the editor and close the popup
        const iframe = `<iframe src="https://giphy.com/embed/${gif_id}" width="480" height="406" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>`;
        editor.selection.setContent(iframe);
        editor.windowManager.close();
      }
    });
  </script>
</body>

</html>